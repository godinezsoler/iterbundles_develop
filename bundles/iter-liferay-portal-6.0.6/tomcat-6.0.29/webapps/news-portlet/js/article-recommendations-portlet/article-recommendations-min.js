var ITER=ITER||{};ITER.RECOMMENDATIONS=ITER.RECOMMENDATIONS||{},ITER.RECOMMENDATIONS.HTTP=ITER.RECOMMENDATIONS.HTTP||(makeAjaxCall=function(e,t){return new Promise(function(r,i){var n=new XMLHttpRequest;n.open(e,t,!0),n.send(),n.onreadystatechange=function(){4===n.readyState&&(200===n.status?r(n.responseText):i(new Error(n.status)))}})},makeFetchCall=function(e,t){return new Promise(function(r,i){fetch(t,{method:e,redirect:"manual"}).then(e=>{"opaqueredirect"===e.type?i("retry"):r(e.text())}).catch(e=>{i(e.status)})})},processHtmlLinks=function(e,t){const r=/^.*-\D{2}.[^-]+$/,i=(new DOMParser).parseFromString(e,"text/html"),n=i.getElementsByTagName("a");for(let e=0;e<n.length;e++){let i=n[e].getAttribute("href");if(r.test(i)){const r=i.indexOf("?"),o=i.indexOf("#"),s=-1!==o?i.substring(o):"";let a=-1===r?"":-1===o?i.substring(r+1):i.substring(r,o);i=-1!==r?i.substring(0,r):-1!==o?i.substring(0,o):i;const c=ITER.RECOMMENDATIONS.CORE.showConfig().masConfig,d={};d.g=c.idgoal,d.c=c.eventcategory,d.a=c.eventaction,d.n=t;const l="mrs="+btoa(JSON.stringify(d));i+=(a=""===a?"?"+l:a+l)+s,n[e].setAttribute("href",i)}}return i.body.innerHTML},{request:async(e,t)=>{let r=0,i="/news-portlet/recommended-articles/"+(t=t.replace(/\/$/,"").replace(/^\//,""));const n=t.split("/").length;let o="";for(;r<n;)try{return await makeFetchCall(e,i)}catch(e){if("retry"!==e){o="Unable to retrieve recommendations. Server response: "+e.message;break}o="Unable to retrieve recommendations due to server load.",console.log(o),console.log("Trying with less options..."),i=i.substr(0,i.lastIndexOf("/")),++r}throw new Error(o)},render:async(e,t,r)=>{var i="/news-portlet/renderArticle/"+e+"/"+btoa(t);try{var n=await makeAjaxCall("GET",i);return processHtmlLinks(n.trim(),r)}catch(e){throw e}},print:function(e,t,r,i){this.render(e,t,r).then(function(e){var t=document.createElement("template");t.innerHTML=e,i.appendChild(t.content.firstChild)})}}),ITER.RECOMMENDATIONS.CORE=ITER.RECOMMENDATIONS.CORE||function(){var e,t={properties:{dbName:"iter_recommendations_db",dbVisitorIdStore:"iter_visitor_id_object_Store",dbArticlesStore:"iter_visited_articles_object_Store"},siteId:"",visitorId:"",masConfig:null},r={visitedArticles:[],portlets:[]};return getMasData=function(){return new Promise((e,r)=>{"undefined"!=typeof Piwik&&"function"==typeof Piwik.getTracker&&("function"==typeof Piwik.getTracker().getSiteId&&(t.siteId=Piwik.getTracker().getSiteId()),"function"==typeof Piwik.getTracker().getVisitorId&&(t.visitorId=Piwik.getTracker().getVisitorId())),""!==t.siteId&&""!==t.visitorId?e():r("MAS is not configured")})},findRecommendationsPortlets=function(){return r.portlets=Array.from(document.querySelectorAll("div.article-recommendations-portlet div[data-config-id][data-template-id]")),r.portlets.length>0},updateVisitorData=function(){return new Promise((e,r)=>{getVisitorId().then(i=>{0==!!i?setVisitorId(t.visitorId).then(()=>{e()}).catch(e=>r(e)):i.value.visitorId!==t.visitorId?Promise.all([setVisitorId(t.visitorId),resetVisitedArticles()]).then(()=>e()).catch(e=>r(e)):e()}).catch(e=>r(e))})},createIndexedDB=function(){return new Promise((r,i)=>{if(window.indexedDB)if(e)r();else{var n=indexedDB.open(t.properties.dbName,1);n.onupgradeneeded=function(e){e.target.result.createObjectStore(t.properties.dbVisitorIdStore,{keyPath:"visitorId"}),e.target.result.createObjectStore(t.properties.dbArticlesStore,{keyPath:"articleId"}).createIndex("visitDate","visitDate",{unique:!1})},n.onsuccess=function(t){e=t.target.result,r()},n.onerror=function(e){i("Database error: "+e.target.error)}}else i("This browser doesn't support IndexedDB")})},getVisitorId=function(){return new Promise((r,i)=>{var n=e.transaction([t.properties.dbVisitorIdStore],"readwrite").objectStore(t.properties.dbVisitorIdStore).openCursor();n.onsuccess=function(e){r(e.target.result)},n.onerror=function(e){i("Error retrieving visitorId from database: "+e.target.error)}})},setVisitorId=function(r){return new Promise((i,n)=>{var o=e.transaction([t.properties.dbVisitorIdStore],"readwrite").objectStore(t.properties.dbVisitorIdStore).clear();o.onsuccess=function(e){var t=e.target.source.add({visitorId:r});t.onsuccess=function(e){i()},t.onerror=function(e){n("Error inserting visitorId in database: "+e.target.error)}},o.onerror=function(e){n("Error deleting visitorId in database: "+e.target.error)}})},checkVisitedArticle=function(){return new Promise((e,t)=>{jQryIter.contextIsArticlePage()&&jQryIter.articleId()?addVisitedArticle(jQryIter.articleId()).then(()=>e()).catch(e=>t(e)):e()})},addVisitedArticle=function(r){return new Promise((i,n)=>{if(r){var o=e.transaction([t.properties.dbArticlesStore],"readwrite").objectStore(t.properties.dbArticlesStore).add({articleId:r,visitDate:Math.floor((new Date).getTime()/1e3)});o.onsuccess=function(e){i()},o.onerror=function(e){"ConstraintError"===e.target.error.name?i():n("Error inserting visited article: "+e.target.error)}}else i()})},getVisitedArticles=function(){return new Promise((i,n)=>{var o=[],s=e.transaction([t.properties.dbArticlesStore],"readwrite"),a=s.objectStore(t.properties.dbArticlesStore);s.oncomplete=function(e){r.visitedArticles=o,i(o)};var c=a.openCursor();c.onsuccess=function(e){var t=e.target.result;t&&(o.push(t.value.articleId),t.continue())},c.onerror=function(e){n("Error retrieving visitorId from database: "+e.target.error)}})},resetVisitedArticles=function(){return new Promise((r,i)=>{var n=e.transaction([t.properties.dbArticlesStore],"readwrite").objectStore(t.properties.dbArticlesStore).clear();n.onsuccess=function(e){r()},n.onerror=function(e){i("Error resetting visited articles: "+e.target.error)}})},setup=function(e){return new Promise((r,i)=>{t.masConfig=e,Promise.all([createIndexedDB(),getMasData()]).then(()=>r()).catch(e=>i(e))})},cleanVisitedArticles=function(r){return new Promise((i,n)=>{if(r){var o=e.transaction([t.properties.dbArticlesStore],"readwrite"),s=o.objectStore(t.properties.dbArticlesStore).index("visitDate"),a=IDBKeyRange.upperBound(r),c=s.openCursor(a);o.oncomplete=function(e){i()},c.onsuccess=function(e){var t=e.target.result;t&&(t.delete(),t.continue())},c.onerror=function(e){n(new Error("Error cleaning visited articles: "+e.target.error))}}else i()})},{init:async e=>{try{ITER.RECOMMENDATIONS.MAS.sendStatistics(),await setup(e),await updateVisitorData(),await checkVisitedArticle(),findRecommendationsPortlets()&&(r.portlets=r.portlets.map(e=>e=new ITER.RECOMMENDATIONS.PORTLET(e,t.visitorId,jQryIter.articleId())))}catch(e){console.log(e)}},showConfig:function(){return t},addVisitedArticle:function(e){return addVisitedArticle(e)},processRecommendationResponse:async e=>{const t=JSON.parse(e);await cleanVisitedArticles(t.lastUpdate),await getVisitedArticles();var i=[],n=0;return t.sources.forEach(e=>{for(e.articles=e.articles.filter(e=>-1===r.visitedArticles.indexOf(e));e.amount>0&&e.articles.length>0;){const t=e.articles[0];e.articles.splice(0,1),void 0===i.find(e=>e===t)&&(i.push(t),e.amount--)}n+=e.amount}),n>0&&t.sources.forEach(e=>{for(;n>0&&e.articles.length>0;){const t=e.articles[0];e.articles.splice(0,1),void 0===i.find(e=>e===t)&&(i.push(t),n--)}}),[i,t.configName]}}}(),ITER.RECOMMENDATIONS.PORTLET=ITER.RECOMMENDATIONS.PORTLET||function(e,t,r){var i={container:e,configId:e.getAttribute("data-config-id"),templateId:e.getAttribute("data-template-id"),visitorId:t,articleId:r};!function(){let e=i.configId+"/"+i.visitorId;i.articleId&&(e+="/"+i.articleId),ITER.RECOMMENDATIONS.HTTP.request("GET",e).then(e=>ITER.RECOMMENDATIONS.CORE.processRecommendationResponse(e)).then(([e,t])=>{e.forEach(e=>{ITER.RECOMMENDATIONS.HTTP.print(e,i.templateId,t,i.container)})}).catch(e=>{console.log(e)})}()},ITER.RECOMMENDATIONS.API=ITER.RECOMMENDATIONS.API||{getRecommendations:function(e,t){if(e)return function(e,t){return new Promise((r,i)=>{let n=e+"/"+ITER.RECOMMENDATIONS.CORE.showConfig().visitorId;t&&(n+="/"+t),ITER.RECOMMENDATIONS.HTTP.request("GET",n).then(e=>{ITER.RECOMMENDATIONS.CORE.processRecommendationResponse(e).then(([e,t])=>{r([e,t])}).catch(e=>{console.log(e)})}).catch(e=>i(e))})}(btoa(e),t)},addVisitedArticle:function(e){return ITER.RECOMMENDATIONS.CORE.addVisitedArticle(e)},renderArticle:function(e,t,r){return ITER.RECOMMENDATIONS.HTTP.render(e,t,r)}},ITER.RECOMMENDATIONS.MAS=ITER.RECOMMENDATIONS.MAS||{sendStatistics:function(){if(jQryIter.contextIsArticlePage()&&"undefined"!=typeof MASStatsMgr&&jQryIter.getQueryParam("mrs")){const e=JSON.parse(atob(jQryIter.getQueryParam("mrs")));MASStatsMgr.sendGoal(e.g),MASStatsMgr.sendEvent(e.c,e.a,e.n)}}};